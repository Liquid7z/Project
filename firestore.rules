/**
 * Core Philosophy: This ruleset enforces a strict user-ownership security model. All
 * user-generated data is stored within a dedicated user-specific document tree, ensuring
 * that users can only access and modify their own information.
 *
 * Data Structure: The entire database is structured hierarchically under the top-level
 * '/users' collection. Each user's data, including their profile, subscriptions, subjects,
 * and notes, is nested under a document corresponding to their unique user ID
 * (e.g., /users/{userId}/...).
 *
 * Key Security Decisions:
 * - Default Deny: All access is denied by default. Permissions are explicitly granted.
 * - No User Listing: It is not possible to list all users in the database, protecting
 *   user privacy.
 * - Strict Ownership: All read and write operations are gated by functions that verify
 *   the authenticated user's ID matches the ID in the document path.
 * - Path and Data Consistency: For collections that denormalize a `userId` or `id`
 *   field within the document, rules enforce that this field matches the path on
 *   creation and is immutable, ensuring relational integrity.
 *
 * Denormalization for Authorization: To ensure fast and simple authorization checks,
 * certain documents contain a denormalized `userId` field. This allows security rules
 * to validate ownership directly from the document data without needing slow and costly
 * `get()` calls to parent documents.
 *
 * Structural Segregation: The data model naturally segregates each user's private data
 * into their own document tree. This structure is inherently secure for list operations,
 * as queries are always scoped to a single user's private collections.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions for reusable logic
    
    /**
     * Checks if a user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the authenticated user's UID matches the provided userId.
     * This is the primary function for enforcing document ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * For update/delete operations, checks ownership AND ensures the document exists.
     * Prevents modifying or deleting a document that does not exist.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }
    
    /**
     * On create, validates that the UserProfile's internal 'id' field matches the
     * document ID, which is the user's UID. Enforces relational integrity.
     */
    function userProfileHasCorrectIdOnCreate(userId) {
      return request.resource.data.id == userId;
    }
    
    /**
     * On update, ensures the UserProfile's internal 'id' field cannot be changed.
     */
    function userProfileIdIsImmutable() {
      return request.resource.data.id == resource.data.id;
    }

    /**
     * On create, validates that a subcollection document's internal 'userId' field
     * matches the {userId} from the path. Enforces relational integrity.
     */
    function hasCorrectUserIdOnCreate(userId) {
      return request.resource.data.userId == userId;
    }
    
    /**
     * On update, ensures a subcollection document's internal 'userId' field is immutable.
     */
    function userIdIsImmutable() {
      return request.resource.data.userId == resource.data.userId;
    }

    /**
     * @description Manages user profile documents. A user can create their own profile,
     *              and can read, update, or delete it. No other user can access it.
     * @path /users/{userId}
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // Disallow listing all users for privacy.
      allow create: if isOwner(userId) && userProfileHasCorrectIdOnCreate(userId);
      allow update: if isExistingOwner(userId) && userProfileIdIsImmutable();
      allow delete: if isExistingOwner(userId);

      /**
       * @description Manages a user's subscription information. Only the user can access or
       *              modify their own subscription data.
       * @path /users/{userId}/subscriptions/{subscriptionId}
       */
      match /subscriptions/{subscriptionId} {
        allow list, get, create, update, delete: if isOwner(userId);
      }
      
      /**
       * @description Manages a user's subjects. Only the user can manage their own subjects.
       * @path /users/{userId}/subjects/{subjectId}
       */
      match /subjects/{subjectId} {
        allow list, get, create, update, delete: if isOwner(userId);

        /**
         * @description Manages notes within a subject. Only the subject owner can manage notes.
         * @path /users/{userId}/subjects/{subjectId}/notes/{noteId}
         */
        match /notes/{noteId} {
          allow list, get, create, update, delete: if isOwner(userId);
        }
      }
    }
  }
}

service firebase.storage {
  match /b/{bucket}/o {
    // Only allow authenticated users to access storage
    match /{allPaths=**} {
      allow read, write: if request.auth != null;
    }

    // Allow users to read and write to their own folder
    match /users/{userId}/{allPaths=**} {
      allow read, write: if request.auth.uid == userId;
    }
  }
}